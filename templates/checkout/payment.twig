{% extends "_layouts/site-base-checkout.twig" %}
{% set cart = craft.commerce.carts.cart %}

{# import macros #}
{% import '_macros/_srcset'  as m_srcset %}
{% import '_macros/_intros'  as m_intros %}
{% import '_macros/_textpic' as m_textpic %}
{% import '_macros/_menu'    as m_menu %}
{% import '_macros/_utils'   as m_utils %}
{% import '_macros/_user'    as m_user %}

{% block titleTag %}
	<title>{{ globalVars.pageTitleBase }} Payment</title>
{% endblock titleTag %}

{% block content %}
    {% set cart = craft.commerce.carts.cart %}
    {% set states = craft.commerce.states.allEnabledStates %}
    {% set billingId = cart.billingAddressId %}
    {% set addresses = craft.commerce.customers.customer.addresses %}
    {% set shipping = cart.shippingAddress %}
    {% set billing = cart.billingAddress %}
    {% set startDate = now|date_modify('+1 day')|atom %} 

    {% if shipping and not billing %}
        {% set billing = shipping %}
    {% endif %}

    <form method="post">
        <input type="hidden" name="action" value="commerce/payments/pay">
        {{ redirectInput('/customer/order?number={number}') }}
        <input type="hidden" name="paymentMethodId" value="1">

        <section row>
            <div class="UserForm PaymentBlock">
                <h1 class="">Payment</h1>
                <div class="UserForm-block">
                    {% if craft.app.session.getFlash("error") %}
                        <div class="alert error" role="alert">
                        {{ craft.app.session.getFlash("error") }}
                        </div>
                    {% endif %}
                    
                    <div class="PaymentBlock-wrapper">
                        <div class="review">
                            <h5>Order Review</h5>
                            {% if ((cart.eventDate|date('D')) == 'Tue') %}
                            <h5>Event Day: {{ cart.eventDate | date('D') }}</h5>
                            {% endif %}
                            <div class="Food">
                                {{ m_menu.showCart(false) }}
                            </div>
                            
                            {#  stripe stuff
                            {% set options = {
                                amount: 99.99, 
                                quantity: 2, 
                                calculateFinalAmount: false,
                                itemName : 'Demaggs Dining',
                                itemDescription : 'Demaggs Dining Experience',
                                checkoutSuccessUrl: '/thank-you?number={number}',
                                checkoutCancelUrl: '/uh-oh'
                            } %}

                            {{ craft.enupalstripe.paymentForm('paymentForm1', options) }}
                            #}
                        </div>

                        <div class="seperator">
                            <div></div>
                        </div>

                        <div class="pay">
                            <h5>Payment Method</h5>

                            {% set formValues = {
                            firstName: paymentForm is defined ? paymentForm.firstName : (cart.billingAddress ? cart.billingAddress.firstName : ''),
                            lastName: paymentForm is defined ? paymentForm.lastName : (cart.billingAddress ? cart.billingAddress.lastName : ''),
                            number: paymentForm is defined ? paymentForm.number : '',
                            cvv: paymentForm is defined ? paymentForm.cvv : '',
                            month: paymentForm is defined ? paymentForm.month : 1,
                            year: paymentForm is defined ? paymentForm.year : currentYear + 1,
                            } %}                            
                            {{ csrfInput() }}
                            <div class="formRow">
                                <span class="w49">
                                    <label for="billingAddress-firstName">Cardholder</label>
                                    <input type="text" name="firstName"
                                            class=""
                                            maxlength="70"
                                            value="{{ formValues.firstName }}" >
                                </span>

                                <span class="w49">
                                    <label for="billingAddress-lastName">&nbsp;</label>
                                    <input type="text" name="lastName"
                                            class=""
                                            maxlength="70"
                                            value="{{ formValues.lastName }}" >
                                </span>
                            </div>

                            <div class="formRow">
                                <span class="w100">
                                    <label for="billingAddress-address1">Card Number</label>
                                    <input type="text" name="number"
                                            class=""
                                            maxlength="19"
                                            value="{{ formValues.number }}" >
                                </span>
                            </div>

                            <div class="formRow">
                                <span class="w30">
                                    <label>Exp: Month</label>
                                    <select name="month">
                                        {% for month in 1..12 %}
                                        <option value="{{ month }}" 
                                                {% if formValues.month == month %} selected{% endif %}>
                                                {{ month }} 
                                        </option>
                                        {% endfor %}
                                    </select>
                                </span>
                                
                                <span class="w30">
                                    <label>Year</label>
                                    <select name="year">
                                        {% for year in currentYear..(currentYear + 12) %}
                                        <option value="{{ year }}" 
                                                {% if formValues.year == year %} selected{% endif %}>
                                                {{ year }} 
                                        </option>
                                        {% endfor %}
                                    </select>
                                </span>

                                <span class="w30">
                                    <label for="cvv">CVC</label>
                                    <input type="text" name="cvv"
                                            placeholder="CVC"
                                            class=""
                                            value="{{ formValues.cvv }}" >
                                </span>
                            </div>

                            {% set errors = [] %}
                            {%if paymentForm is defined %}
                            {% for attributeKey in ['firstName', 'lastName', 'number', 'month', 'year', 'cvv'] %}
                                {% set errors = errors|merge(paymentForm.getErrors(attributeKey)) %}
                            {% endfor %}
                            {% endif %}

                            {% if errors|length > 0 %}
                            <div class="ErrorList">
                                <p>Please fix the following errors:</p>
                                <ul>
                                    {% for error in errors %}
                                        <li>&nbsp;{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                                    
                        </div>
                    </div>
                    <div class="btnRow">
                        <a class="button off" href="/checkout/billing">Previous</a>
                        <input class="button" type="submit" value="Submit Order">
                    </div>
                </div>
            </div>
       </section>

    </form>

{% endblock content %}

{% block pageJs %}
    {{ m_utils.setProgress('s5', 'Checkout') }}
{% endblock pageJs %}
